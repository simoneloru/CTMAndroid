from datetime import datetime,timedelta
import time
import os
import urllib
import urllib2
import re
from bs4 import BeautifulSoup
import telepot


os.environ['TZ'] = 'Europe/Rome'
fermate = {2:"CI0002",3:"CI0003",4:"DO0004",5:"DO0005",6:"CI0006",7:"CI0007",8:"BA0008",9:"BA0009",10:"BA0010",11:"BA0011",12:"CC0012",13:"BA0013",14:"BA0014",15:"BA0015",16:"BA0016",17:"AL0017",18:"AL0018",19:"SO0019",20:"SO0020",21:"SO0021",22:"SE0022",23:"SE0023",24:"RM0024",26:"RM0026",28:"PM0028",29:"PM0029",30:"PM0030",32:"QR0032",33:"LY0033",35:"LY0035",36:"SP0036",37:"LY0037",39:"RM0039",40:"RM0040",41:"TS0041",42:"CF0042",43:"CF0043",44:"MM0044",45:"MM0045",46:"CF0046",47:"PY0047",48:"VE0048",49:"MN0049",50:"MN0050",51:"CZ0051",53:"RL0053",54:"GB0054",55:"GB0055",56:"PY0056",57:"SA0057",58:"SA0058",59:"SG0059",60:"OS0060",61:"OS0061",62:"PR0062",63:"RL0063",64:"RL0064",65:"BU0065",66:"RL0066",67:"RL0067",68:"BU0068",69:"BU0069",70:"BU0070",71:"LV0071",72:"LV0072",74:"BS0074",75:"PI0075",76:"RN0076",77:"IR0077",78:"LI0078",79:"LI0079",80:"GN0080",81:"LI0081",82:"CA0082",83:"CA0083",84:"CD0084",85:"CA0085",86:"IM0086",87:"IM0087",88:"MP0088",89:"CD0089",90:"CD0090",91:"CD0091",92:"CD0092",94:"MP0094",95:"MP0095",98:"QR0098",99:"IM0099",100:"IM0100",101:"IM0101",102:"IM0102",103:"IM0103",104:"EM0104",106:"SM0106",108:"SM0108",109:"AB0109",110:"AB0110",112:"AM0112",113:"CR0113",114:"CR0114",115:"CR0115",117:"EL0117",118:"GN0118",119:"PC0119",120:"LU0120",121:"VN0121",122:"PU0122",123:"FN0123",124:"EL0124",125:"EL0125",127:"EL0127",128:"EL0128",129:"EL0129",130:"EL0130",131:"JE0131",133:"CR0133",134:"PF0134",135:"PF0135",136:"CS0136",137:"CS0137",139:"CP0139",140:"GT0140",141:"GT0141",142:"SM0142",143:"SM0143",144:"AV0144",145:"AV0145",146:"AV0146",147:"AV0147",148:"AV0148",149:"AV0149",150:"TS0150",151:"TS0151",152:"TN0152",153:"TN0153",154:"TN0154",155:"TN0155",156:"ME0156",157:"ME0157",158:"NS0158",159:"PO0159",160:"TS0160",161:"TS0161",162:"TS0162",163:"MM0163",164:"ME0164",165:"ME0165",166:"ME0166",167:"ME0167",168:"ME0168",170:"AM0170",171:"IM0171",172:"MS0172",173:"MS0173",174:"MS0174",177:"MS0177",178:"MS0178",179:"MS0179",180:"LP0180",181:"MS0181",182:"MS0182",183:"AD0183",184:"AL0184",185:"AL0185",186:"SC0186",187:"SC0187",188:"CO0188",189:"CO0189",190:"PE0190",191:"PE0191",192:"PE0192",193:"PE0193",195:"BE0195",196:"DA0196",197:"DA0197",198:"PL0198",199:"PL0199",200:"TZ0200",201:"TZ0201",202:"CC0202",203:"PT0203",204:"PT0204",205:"PA0205",206:"DA0206",207:"BE0207",208:"BE0208",209:"AZ0209",210:"AZ0210",211:"AZ0211",212:"AZ0212",213:"ST0213",214:"FG0214",215:"BS0215",216:"CL0216",217:"BE0217",218:"MA0218",219:"MA0219",220:"MA0220",221:"PG0221",222:"PG0222",223:"FE0223",224:"FE0224",225:"DO0225",226:"DO0226",227:"CT0227",228:"CT0228",229:"MA0229",230:"MA0230",231:"CT0231",232:"CT0232",233:"CI0233",234:"CI0234",235:"CI0235",236:"CI0236",237:"RV0237",238:"RV0238",239:"MC0239",240:"MC0240",241:"AD0241",242:"MC0242",243:"RV0243",244:"RV0244",245:"OE0245",246:"MO0246",247:"VS0247",248:"DC0248",249:"GI0249",250:"GI0250",251:"GI0251",252:"GI0252",253:"MA0253",254:"MA0254",255:"MA0255",256:"MA0256",257:"PS0257",258:"PS0258",259:"SC0259",260:"SC0260",261:"SC0261",262:"SC0262",263:"PS0263",264:"PS0264",265:"AD0265",266:"BO0266",267:"BO0267",268:"BO0268",269:"BO0269",270:"DA0270",271:"DA0271",272:"DA0272",273:"DA0273",274:"AD0274",275:"AD0275",276:"BO0276",277:"BO0277",278:"AD0278",279:"AD0279",280:"MI0280",281:"MI0281",282:"AD0282",283:"AD0283",284:"MI0284",285:"MI0285",286:"MI0286",287:"MI0287",288:"DP0288",289:"DP0289",290:"DP0290",291:"DP0291",292:"DP0292",293:"DP0293",294:"DP0294",295:"DP0295",296:"DP0296",297:"DP0297",298:"AD0298",299:"GC0299",300:"GU0300",301:"GC0301",302:"GC0302",303:"EN0303",304:"EN0304",305:"EN0305",306:"EN0306",307:"FR0307",308:"LP0308",309:"DA0309",310:"LP0310",311:"TR0311",312:"DA0312",313:"AQ0313",314:"FA0314",315:"LB0315",316:"SI0316",317:"AT0317",318:"DS0318",319:"DS0319",320:"FA0320",322:"LP0322",323:"BS0323",324:"BS0324",325:"BS0325",326:"BS0326",327:"LL0327",328:"LP0328",329:"LP0329",330:"LP0330",331:"LP0331",332:"LP0332",333:"LP0333",334:"CM0334",335:"LP0335",336:"DS0336",337:"CL0337",338:"CL0338",339:"CL0339",340:"CL0340",341:"BS0341",342:"BS0342",343:"SV0343",344:"SV0344",345:"BN0345",346:"SV0346",347:"SV0347",348:"LS0348",349:"LS0349",350:"LP0350",351:"LP0351",352:"LP0352",353:"LP0353",354:"LP0354",355:"LP0355",356:"LP0356",357:"LP0357",358:"LP0358",359:"LP0359",360:"EL0360",361:"EL0361",362:"EL0362",363:"EL0363",364:"RS0364",365:"VS0365",366:"VS0366",367:"VE0367",368:"VE0368",369:"CO0369",370:"CL0370",371:"LP0371",372:"MT0372",373:"LP0373",374:"LP0374",375:"LP0375",376:"LP0376",377:"LP0377",378:"LP0378",379:"LP0379",380:"GQ0380",381:"LP0381",382:"LP0382",383:"GQ0383",384:"GQ0384",385:"GQ0385",386:"GQ0386",387:"GQ0387",388:"GQ0388",389:"GQ0389",391:"LP0391",392:"GQ0392",393:"LP0393",394:"GQ0394",395:"GN0395",397:"GQ0397",398:"GQ0398",399:"GQ0399",400:"GQ0400",401:"MR0401",402:"MR0402",403:"MR0403",404:"MR0404",405:"MR0405",406:"MR0406",407:"MR0407",408:"MR0408",409:"MR0409",410:"MR0410",411:"MR0411",412:"MR0412",413:"FL0413",414:"DV0414",415:"DV0415",416:"DV0416",417:"DV0417",419:"DV0419",420:"DV0420",421:"DV0421",422:"DV0422",423:"DV0423",424:"DV0424",425:"DV0425",427:"CB0427",428:"PV0428",429:"PV0429",430:"PV0430",431:"PV0431",432:"PV0432",433:"PV0433",434:"PV0434",435:"PV0435",436:"PV0436",437:"PV0437",438:"PV0438",439:"PV0439",440:"PV0440",441:"PV0441",442:"TM0442",443:"FI0443",445:"FI0445",446:"FI0446",447:"FI0447",448:"FI0448",449:"FI0449",451:"AN0451",452:"FB0452",453:"FB0453",454:"GV0454",455:"GV0455",456:"GV0456",457:"GV0457",458:"CO0458",459:"CO0459",460:"CO0460",461:"CO0461",462:"CO0462",463:"CO0463",464:"MA0464",465:"MA0465",466:"BR0466",467:"CB0467",469:"SE0469",470:"MA0470",472:"PV0472",475:"PV0475",476:"ME0476",477:"SI0477",478:"MA0478",479:"CB0479",480:"MA0480",481:"CB0481",482:"MA0482",483:"MA0483",488:"MG0488",489:"MG0489",490:"MG0490",491:"MG0491",492:"MA0492",493:"MA0493",494:"FL0494",496:"GA0496",497:"GA0497",498:"RO0498",500:"DM0500",501:"DM0501",502:"DM0502",503:"BR0503",504:"DM0504",505:"DM0505",506:"TS0506",507:"TS0507",509:"BR0509",510:"RS0510",513:"VR0513",515:"AR0515",516:"FL0516",517:"VR0517",519:"MA0519",520:"HB0520",521:"MA0521",522:"CO0522",523:"CO0523",524:"CO0524",525:"CO0525",526:"TS0526",527:"TS0527",528:"TS0528",529:"TS0529",530:"TS0530",531:"TS0531",532:"ZU0532",538:"RE0538",541:"SV0541",542:"SG0542",547:"CB0547",549:"IT0549",551:"IT0551",552:"IT0552",553:"EC0553",555:"MC0555",556:"RV0556",558:"FL0558",559:"JE0559",560:"JE0560",564:"GN0564",565:"BC0565",566:"CD0566",567:"GN0567",569:"GN0569",577:"EL0577",578:"EL0578",581:"EL0581",582:"EL0582",583:"AG0583",584:"SE0584",586:"SE0586",587:"SE0587",588:"SE0588",589:"SE0589",590:"SE0590",591:"SE0591",592:"SE0592",593:"SE0593",594:"SE0594",595:"SA0595",596:"SA0596",597:"CM0597",598:"CM0598",599:"CM0599",600:"CM0600",601:"CM0601",602:"CM0602",603:"CM0603",604:"CM0604",605:"CM0605",606:"CM0606",610:"CA0610",613:"CA0613",614:"SL0614",615:"SD0615",616:"SD0616",617:"SD0617",618:"SD0618",619:"NA0619",620:"NA0620",621:"NA0621",622:"NA0622",623:"MA0623",624:"NA0624",625:"NA0625",626:"PF0626",627:"ST0627",628:"ST0628",632:"AD0632",633:"FL0633",634:"TS0634",635:"TS0635",636:"MA0636",638:"SV0638",639:"SD0639",640:"GI0640",642:"SV0642",643:"DV0643",644:"CP0644",645:"SV0645",646:"SV0646",647:"PG0647",648:"MT0648",653:"LO0653",654:"CB0654",655:"RM0655",656:"VR0656",658:"GT0658",659:"GT0659",660:"PR0660",661:"GT0661",662:"GT0662",663:"GT0663",664:"VR0664",665:"RM0665",666:"GT0666",668:"IS0668",669:"IS0669",670:"MZ0670",672:"BV0672",675:"RM0675",676:"GD0676",677:"SS0677",678:"BE0678",679:"BE0679",680:"EL0680",681:"EL0681",682:"AN0682",683:"SN0683",684:"VS0684",685:"VS0685",687:"PV0687",688:"RS0688",689:"RS0689",690:"IT0690",691:"EL0691",697:"PZ0697",699:"PG0699",700:"AN0700",701:"NO0701",702:"PJ0702",703:"PI0703",704:"PZ0704",705:"PZ0705",706:"NP0706",707:"NP0707",708:"PZ0708",709:"PZ0709",710:"FU0710",711:"FU0711",712:"EC0712",713:"EC0713",714:"EC0714",715:"EC0715",716:"EC0716",717:"EC0717",718:"EC0718",719:"EC0719",720:"AG0720",721:"AG0721",722:"AG0722",723:"AG0723",724:"AG0724",725:"AG0725",726:"AG0726",727:"AG0727",728:"DV0728",729:"DV0729",730:"SA0730",731:"SA0731",732:"GH0732",733:"VB0733",734:"RM0734",735:"CU0735",736:"AG0736",737:"FG0737",738:"LI0738",739:"RM0739",740:"MR0740",741:"CU0741",742:"GT0742",743:"DM0743",744:"ID0744",745:"MN0745",746:"RT0746",747:"BO0747",748:"RT0748",749:"RL0749",750:"SS0750",751:"SS0751",752:"PZ0752",753:"PZ0753",754:"DV0754",755:"MR0755",758:"UN0758",760:"GP0760",761:"GP0761",762:"GP0762",763:"GP0763",764:"GP0764",765:"GP0765",766:"DD0766",767:"GT0767",768:"MS0768",769:"MS0769",770:"AG0770",771:"AG0771",772:"PV0772",803:"CR0803",804:"CR0804",805:"GT0805",806:"DD0806",807:"DD0807",809:"CR0809",810:"AM0810",811:"SO0811",812:"RS0812",813:"BA0813",814:"GC0814",815:"IT0815",816:"GC0816",817:"PA0817",818:"SG0818",819:"AG0819",820:"AG0820",821:"RE0821",823:"CB0823",824:"IT0824",825:"LE0825",826:"GC0826",829:"GC0829",830:"UV0830",832:"PM0832",833:"GH0833",834:"PS0834",835:"PS0835",836:"GC0836",837:"RE0837",838:"RE0838",839:"SD0839",842:"JE0842",844:"RO0844",845:"PF0845",846:"BD0846",847:"BD0847",848:"BD0848",849:"NO0849",851:"PG0851",852:"AG0852",853:"EC0853",855:"VD0855",856:"VD0856",857:"RG0857",858:"BI0858",860:"IG0860",861:"GC0861",862:"GC0862",863:"DQ0863",864:"RG0864",865:"VD0865",866:"VD0866",867:"PS0867",868:"MT0868",869:"JE0869",870:"JE0870",872:"JE0872",873:"TI0873",874:"BT0874",875:"BT0875",876:"TO0876",877:"MH0877",878:"CM0878",879:"TB0879",881:"GT0881",882:"GT0882",883:"CP0883",884:"DT0884",885:"CS0885",886:"CS0886",887:"PF0887",890:"CR0890",891:"SR0891",892:"MP0892",894:"AB0894",896:"DT0896",900:"CU0900",901:"SV0901",902:"SV0902",903:"CG0903",904:"AN0904",905:"CG0905",906:"BS0906",907:"SV0907",909:"LM0909",910:"LM0910",911:"MA0911",912:"MA0912",913:"EU0913",914:"BR0914",915:"MA0915",916:"BR0916",917:"AD0917",918:"CU0918",919:"CU0919",920:"DE0920",925:"DA0925",935:"BD0935",936:"BD0936",937:"BD0937",938:"BD0938",940:"DV0940",941:"FI0941",942:"FI0942",945:"VV0945",946:"SS0946",947:"GT0947",948:"LP0948",955:"CH0955",956:"NZ0956",957:"NZ0957",958:"NZ0958",959:"DS0959",960:"DS0960",961:"LV0961",962:"NZ0962",963:"NZ0963",964:"NZ0964",965:"NZ0965",966:"MD0966",968:"BO0968",970:"MU0970",971:"AR0971",972:"LS0972",973:"AR0973",974:"AR0974",975:"MU0975",977:"PR0977",978:"PR0978",979:"PO0979",981:"MO0981",982:"PJ0982",984:"DA0984",986:"FM0986",987:"FM0987",988:"PL0988",989:"DP0989",990:"VB0990",991:"TA0991",992:"GV0992",993:"PZ0993",996:"PZ0996",997:"GV0997",998:"VR0998",999:"PL0999","XXX":"LP0XXX",1000:"AS1000",1001:"ZI1001",1002:"ZI1002",1003:"ZI1003",1004:"ZI1004",1005:"ZI1005",1006:"ZI1006",1007:"ZI1007",1008:"ZI1008",1009:"ZI1009",1010:"ZI1010",1011:"ZI1011",1012:"ZI1012",1013:"ZI1013",1014:"ZI1014",1015:"ZI1015",1016:"RE1016",1018:"SG1018",1019:"SG1019",1020:"SG1020",1021:"SR1021",1022:"SG1022",1023:"SG1023",1024:"SU1024",1101:"CH1101",1102:"DP1102",1103:"CH1103",1104:"TC1104",1105:"TC1105",1106:"DZ1106",1107:"NG1107",1108:"GN1108",1109:"FA1109",1110:"SM1110",1111:"CA1111",1112:"CA1112",1113:"AS1113",1114:"FA1114",1115:"BL1115",1118:"RS1118",1120:"FI1120",1122:"BL1122",1123:"IL1123",1124:"ET1124",1125:"GS1125",1126:"GS1126",1127:"AI1127",1128:"DM1128",1129:"AG1129",1130:"AG1130",1131:"BI1131",1132:"DG1132",1133:"AH1133",1134:"PV1134",1135:"CV1135",1136:"IN1136",1137:"IN1137",1138:"NZ1138",1139:"CP1139",1140:"CQ1140",1141:"CO1141",1142:"AU1142",1143:"SA1143",1144:"PT1144",1145:"AH1145",1146:"LY1146",1147:"DA1147",1148:"CQ1148",1149:"TS1149",1150:"TS1150",1151:"ME1151",1152:"BM1152",1153:"BM1153",1154:"AG1154",1155:"AG1155",1156:"LP1156",1157:"PL1157",1158:"DQ1158",1159:"DQ1159",1160:"MC1160",1161:"PL1161",1163:"EU1163",1164:"EU1164",1165:"SR1165",1166:"AF1166",1168:"PM1168",1169:"SP1169",1170:"AF1170",1174:"CM1174",1176:"AF1176",1177:"AF1177",1178:"BA1178",1179:"EU1179",1181:"PV1181",1183:"PB1183",1184:"PB1184",1185:"PB1185",1186:"SF1186",1187:"CA1187",1188:"CA1188",1190:"BM1190",1191:"BM1191",1192:"BI1192",1198:"CA1198",1200:"PM1200",1250:"SD1250",1251:"CB1251",1252:"CB1252",1253:"CI1253",1254:"CI1254",1256:"SF1256",1257:"RS1257",1258:"PZ1258",1259:"PZ1259",1261:"MU1261",1265:"MA1265",1267:"LI1267",1271:"QU1271",1272:"PC1272",1999:"CO1999",2000:"BU2000",2001:"BU2001",2005:"AU2005",2007:"AU2007",2008:"BO2008",2009:"SP2009",2010:"SF2010",2012:"RE2012",2014:"RE2014",2015:"FA2015",2016:"GH2016",2017:"GH2017",2018:"FI2018",2019:"FI2019",2020:"FI2020",2021:"FI2021",2022:"CS2022",2023:"CS2023",2024:"BD2024",2025:"BU2025",2026:"IM2026",2027:"MO2027",2030:"IT2030",2035:"CP2035",2037:"MS2037",2038:"MS2038",2039:"TA2039",2040:"RM2040",2041:"AR2041",2042:"DA2042",2043:"SO2043",2044:"AL2044",2045:"AZ2045",2046:"AZ2046",2047:"BE2047",2048:"LI2048",2049:"LR2049",2050:"LI2050",2051:"BE2051",2052:"BE2052",2053:"AZ2053",2054:"AZ2054","A607":"CA607","A609":"CA609","A611":"CA611"}

botid = 'YOUR_BOT_ID'
bot = telepot.Bot(botid)

def callServer(num):
     endTime = datetime.now() + timedelta(hours=1)
     nodata = "Dati non disponibili"
     url = 'http://mapserver.muovetevi.it/pt.asp'
     try:
          fermate[num]
     except Exception, e:
          return "Mi dispiace, non ho trovato una fermata con quel codice"
     rispostaOrari = "Ciao, ecco gli orari per la fermata da te richesta per la prossima ora (gli orari con l'asterisco sono in tempo reale): \n"
     values = {'mode' : '1',
          'stopcode' : fermate[num],
          'stopdescr' : '-1',
          'linenames' : '-1',
          'ptsearch' : 'Ricerca',
          'pt_day' : time.strftime('%d'),
          'pt_month' : time.strftime('%m'),
          'pt_year' : time.strftime('%Y'),
          'PT_HH_FROM' : time.strftime('%H'),
          'PT_HH_TO' : endTime.strftime('%H'),
          'PT_MM_FROM' : time.strftime('%M'),
          'PT_MM_TO' : time.strftime('%M')
          }


     data = urllib.urlencode(values)
     req = urllib2.Request(url, data)
     response = urllib2.urlopen(req)
     the_page = response.read()

     if nodata in the_page:
          return "Mi dispiace, non ci sono dati disponibili per la fermata richiesta"
     soup = BeautifulSoup(the_page,"html5lib")

     orari = ""

     for ora in soup.find_all('table'):
          orari+= ora.caption.get_text() + "\n"
          for tr in ora.tbody.find_all('tr'):
               for td in tr.find_all('td'):
                    orari+= tr.th.get_text() + ':' +  td.get_text() + '\n'
     return rispostaOrari + orari




def handle(msg):
     chat_id = msg['from']['id']
     command = msg['text']

     if command == '/time':
          bot.sendMessage(chat_id,str(datetime.datetime.now()))
     elif command.isdigit():
          bot.sendMessage(chat_id,callServer(int(float(command))))
     else:
          bot.sendMessage(chat_id,"Mi dispiace, non ho capito. Per adesso sono in grado di comprendere solo numeri di fermata :)")
    
bot.notifyOnMessage(handle)

while 1:
     time.sleep(10)